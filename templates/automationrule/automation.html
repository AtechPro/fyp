<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Automation Rule</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/automaterule/automation.css">
</head>
<body>
    <nav class="sidebar">
        {% include 'navigation/nav.html' %}
    </nav>
    <div class="container mt-5">
        <h1>Create Automation Rule</h1>
        <form id="automationForm" class="mt-4">
            <div class="form-group">
                <label for="sensor_select">Select Sensor</label>
                <select class="form-control" id="sensor_select" name="sensor_id" required>
                    <option value="">Choose a sensor...</option>
                </select>
                <small class="form-text text-muted">
                    Sensor type: <span id="sensor_type"></span>
                </small>
                <small class="form-text text-muted">
                    Current value: <span id="current_value"></span>
                </small>
            </div>
            <div class="form-group">
                <label for="threshold">Threshold</label>
                <div id="continuous_input" style="display: none;">
                    <input type="number" step="any" class="form-control" id="threshold_continuous">
                    <small class="form-text text-muted">
                        Unit: <span id="unit_display"></span>
                    </small>
                </div>
                <div id="binary_input" style="display: none;">
                    <select class="form-control" id="threshold_binary"></select>
                </div>
            </div>
            <div class="form-group">
                <label for="relay_device_id">Relay Device</label>
                <select class="form-control" id="relay_device_id" name="relay_device_id" required>
                    <option value="">Choose a relay...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="relay_state">Relay State</label>
                <select class="form-control" id="relay_state" name="relay_state" required>
                    <option value="ON">ON</option>
                    <option value="OFF">OFF</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Create Rule</button>
        </form>
        <div id="message" class="mt-3"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function() {
            // Load sensors
            $.get('/api/automation_rules/sensors', function(sensors) {
                sensors.forEach(sensor => {
                    $('#sensor_select').append(
                        $('<option>', {
                            value: sensor.id,
                            text: `${sensor.device_id} - ${sensor.sensor_key} (${sensor.type})`
                        })
                    );
                });
            });

            // Load relay devices
            $.get('/api/automation_rules/relays', function(relays) {
                relays.forEach(relay => {
                    $('#relay_device_id').append(
                        $('<option>', {
                            value: relay.id,
                            text: relay.title || relay.device_id
                        })
                    );
                });
            });

            // Update sensor info on selection
            $('#sensor_select').change(function() {
                const sensorId = $(this).val();
                if (!sensorId) return;

                $.get(`/api/automation_rules/sensor/${sensorId}`, function(sensor) {
                    $('#sensor_type').text(sensor.type);
                    $('#current_value').text(sensor.current_value || 'N/A');

                    if (sensor.states && sensor.states.length > 0) {
                        $('#binary_input').show();
                        $('#continuous_input').hide();
                        $('#threshold_binary').empty();
                        sensor.states.forEach(state => {
                            $('#threshold_binary').append($('<option>', { value: state, text: state }));
                        });
                    } else {
                        $('#binary_input').hide();
                        $('#continuous_input').show();
                        $('#unit_display').text(sensor.unit || '');
                    }
                });
            });

            // Handle form submission
            $('#automationForm').on('submit', function(event) {
                event.preventDefault();
                const data = {
                    sensor_id: $('#sensor_select').val(),
                    threshold: $('#binary_input').is(':visible')
                        ? $('#threshold_binary').val()
                        : $('#threshold_continuous').val(),
                    relay_device_id: $('#relay_device_id').val(),
                    relay_state: $('#relay_state').val()
                };

                $.ajax({
                    url: '/automation_rule',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(response) {
                        $('#message').html(`<div class="alert alert-success">${response.message}</div>`);
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON ? xhr.responseJSON.error : 'An error occurred';
                        $('#message').html(`<div class="alert alert-danger">${error}</div>`);
                    }
                });
            });
        });
    </script>
</body>
</html>
